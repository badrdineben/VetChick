<script>
  async function uploadImage(imageFile) {
    const formData = new FormData();
    formData.append("file", imageFile);
    formData.append("upload_preset", "vet_chick_preset"); // Use your preset name

    try {
      // ğŸ”¥ Upload image to Cloudinary (Now with correct upload preset)
      const uploadRes = await fetch("https://api.cloudinary.com/v1_1/chicken/image/upload", {
        method: "POST",
        body: formData,
      });

      const uploadJson = await uploadRes.json();
      console.log("Cloudinary response:", uploadJson);

      if (!uploadJson.secure_url) {
        alert("Failed to upload image!");
        return null;
      }

      return uploadJson.secure_url;
    } catch (err) {
      console.error("Upload failed:", err);
      alert("Image upload failed!");
      return null;
    }
  }

  document.getElementById("diagnosis-form").addEventListener("submit", async function (e) {
    e.preventDefault();
    const imageInput = document.getElementById("image").files[0];
    const note = document.getElementById("note").value;
    if (!imageInput) return alert("ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ ØµÙˆØ±Ø© / Please upload an image");

    const imageUrl = await uploadImage(imageInput);
    if (!imageUrl) return;

    try {
      // ğŸ”µ Send Image URL to GPT-4 Vision
      const gptRes = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer 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"
        },
        body: JSON.stringify({
          model: "gpt-4-vision-preview",
          messages: [
            {
              role: "user",
              content: [
                { type: "text", text: "Analyze this chicken image. Notes from user: " + note },
                { type: "image_url", image_url: { url: imageUrl } }
              ]
            }
          ],
          max_tokens: 1000
        })
      });

      const resultText = await gptRes.text();
      console.log("GPT-4 Response:", resultText);
      const result = JSON.parse(resultText);

      const output = result.choices?.[0]?.message?.content || "ØªØ´Ø®ÙŠØµ ØºÙŠØ± Ù…ØªÙˆÙØ± / Diagnosis unavailable";
      const lines = output.split("\n");

      document.getElementById("disease-name").textContent = lines[0] || "-";
      document.getElementById("disease-description").textContent = lines[1] || "-";
      document.getElementById("treatment-plan").textContent = lines[2] || "-";
      document.getElementById("medicine-name").textContent = lines[3] || "-";
      document.getElementById("medicine-usage").textContent = lines[4] || "-";

      document.getElementById("result-section").style.display = "block";
    } catch (err) {
      alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© / Error during image analysis");
      console.error("Full error:", err);
    }
  });
</script>
